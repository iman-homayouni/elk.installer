#! /bin/bash
# Programming and idea by : Iman Homayouni
# Gitbub : https://github.com/iman-homayouni
# Email : homayouni.iman@Gmail.com
# Website : http://www.homayouni.info
# License : GPL v2.0
# Last update : 15-March-2021_09:13:05
# elk.installer v1.0.1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
# SUCCESSFULLY TESTED IN UBUNTU 20.04 [FOCAL]
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# PRINT MSG TO TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
clear
echo -e "[>>] ----------------------------------------------------------- [<<]"
echo -e "[>>] Programming and idea by : Iman Homayouni                    [<<]"
echo -e "[>>] Gitbub : https://github.com/iman-homayouni                  [<<]"
echo -e "[>>] Email : homayouni.iman@Gmail.com                            [<<]"
echo -e "[>>] ----------------------------------------------------------- [<<]"
echo -e "[>>] INSTALL ELASTICSEARCH + KIBANA + LOGSTASH + FILE BEATE      [<<]"
echo -e "[>>] SINGLE NODE IN UBUNTU 20.04                                 [<<]"
echo -e "[>>] ----------------------------------------------------------- [<<]"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



function check {
    # CHECK CONFIGURATION FILE # -------------------------------------------------------------------------------------------------------------------------- #
    [ ! -f elk.installer.conf ] && echo -e "\e[91m [>>] cannot access 'elk.installer.conf': No such file or directory \e[0m" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # LOAD VARIABLE FROM CONFIGURATION FILE # ------------------------------------------------------------------------------------------------------------- #
    source elk.installer.conf
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK CONFIGURATION VARIABLES # --------------------------------------------------------------------------------------------------------------------- #
    [ -z "$proxy_address" ] && echo "\e[91m [>>] proxy_address VARIABLE IS EMPTY \e[0m"         && exit 1
    [ -z "$proxy_port" ]    && echo "\e[91m [>>] proxy_port VARIABLE IS EMPTY \e[0m"            && exit 1
    [ -z "$kibana_username" ] && echo "\e[91m [>>] kibana_username VARIABLE IS EMPTY \e[0m"     && exit 1
    [ -z "$kibana_password" ]    && echo "\e[91m [>>] kibana_password VARIABLE IS EMPTY \e[0m"  && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}

check

# UPDATE AND UPGRADE SYSTEM # ----------------------------------------------------------------------------------------------------------------------------- #
apt-get update
apt-get -y dist-upgrade
apt -y autoremove
apt-get -y -f install
apt-get clean
apt-get install net-tools
apt-get install -y lsb-release &> /dev/null
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK lsb_release # ------------------------------------------------------------------------------------------------------------------------------------- #
which lsb_release &> /dev/null
[ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT FIND lsb_release COMMAND\e[0m" && exit !
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK OS CODENAME # ------------------------------------------------------------------------------------------------------------------------------------- #
lsb_release -cs | grep 'focal' &> /dev/null
[ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT INSTALL NETDATA IN YOUR OS\e[0m"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL SOME PACKAGES # --------------------------------------------------------------------------------------------------------------------------------- #
apt-get install -y apt-transport-https jq apache2-utils
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ADD SHECAN DNS SERVER IN SYSTEM # ----------------------------------------------------------------------------------------------------------------------- #
echo -e "nameserver 185.51.200.2\nnameserver 178.22.122.100" > /etc/resolv.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL OpenJDK IN SYSTEM # ----------------------------------------------------------------------------------------------------------------------------- #
apt-get install -y openjdk-8-jdk
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL NGINX IN SYSTEM # ------------------------------------------------------------------------------------------------------------------------------- #
apt-get install -y nginx
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# STOP NGINX SERVICE # ------------------------------------------------------------------------------------------------------------------------------------ #
systemctl stop nginx
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ENABLE NGINX SERVICE # ---------------------------------------------------------------------------------------------------------------------------------- #
systemctl enable nginx
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# GET ELK REPO KEY AND ADD TO SYSTEM # -------------------------------------------------------------------------------------------------------------------- #
curl -x http://$proxy_address:$proxy_port -s https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ADD ELK REPOSITORY IN SYSTEM # -------------------------------------------------------------------------------------------------------------------------- #
echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" > /etc/apt/sources.list.d/elastic-7.x.list
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# UPDATE SYSTEM PACKAGES # -------------------------------------------------------------------------------------------------------------------------------- #
apt-get update
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL ELK PACKAGE # ----------------------------------------------------------------------------------------------------------------------------------- #
apt-get install elasticsearch
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# STOP ELK SERVICE # -------------------------------------------------------------------------------------------------------------------------------------- #
systemctl stop elasticsearch.service
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ENABLE ELK SERVICE # ------------------------------------------------------------------------------------------------------------------------------------ #
systemctl enable elasticsearch.service
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE BACKUP FROM ELK CONFIGURATION FILE # ------------------------------------------------------------------------------------------------------------- #
cp /etc/elasticsearch/elasticsearch.yml /etc/elasticsearch/elasticsearch.yml.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE ELK # ----------------------------------------------------------------------------------------------------------------------------------------- #
echo 'network.host: localhost' >> /etc/elasticsearch/elasticsearch.yml
echo 'http.port: 9200' >> /etc/elasticsearch/elasticsearch.yml
echo 'discovery.type: single-node' >> /etc/elasticsearch/elasticsearch.yml
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE BACKUP FROM JVM FILE # --------------------------------------------------------------------------------------------------------------------------- #
cp /etc/elasticsearch/jvm.options /etc/elasticsearch/jvm.options.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE JVM HEAP SIZE # ------------------------------------------------------------------------------------------------------------------------------- #
echo '-Xms512m' >> /etc/elasticsearch/jvm.options
echo '-Xmx512m' >> /etc/elasticsearch/jvm.options
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# START ELK SERVICE # ------------------------------------------------------------------------------------------------------------------------------------- #
systemctl start elasticsearch.service
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# TESTING ELK CONNECTION # -------------------------------------------------------------------------------------------------------------------------------- #
curl -sX GET "localhost:9200"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL KIBANA PACKAGE # -------------------------------------------------------------------------------------------------------------------------------- #
apt-get install kibana
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# STOP KIBANA SERVICE # ----------------------------------------------------------------------------------------------------------------------------------- #
systemctl stop kibana
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ENABLE KIBANA SERVICE # --------------------------------------------------------------------------------------------------------------------------------- #
systemctl enable kibana
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE BACKUP FROM KIBANA CONFIG FILE # ----------------------------------------------------------------------------------------------------------------- #
cp /etc/kibana/kibana.yml /etc/kibana/kibana.yml.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CONFIGURE KIBANA # ------------------------------------------------------------------------------------------------------------------------------------- #
echo -e "server.port: 5601" >> /etc/kibana/kibana.yml
echo -e "server.host: 127.0.0.1" >> /etc/kibana/kibana.yml
echo -e 'elasticsearch.hosts: ["http://localhost:9200"]' >> /etc/kibana/kibana.yml
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# START KIBANA SERVICE # ---------------------------------------------------------------------------------------------------------------------------------- #
systemctl start kibana
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# PRINT STATUS OF KIBANA SERVICE # ------------------------------------------------------------------------------------------------------------------------ #
systemctl status kibana
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE ACCESS [USERNAME AND PASSWORD] FOR CONNECTING TO NGINX WEB SERVER # ------------------------------------------------------------------------------ #
rm -rf /etc/nginx/.htpasswd &> /dev/null
htpasswd -cdb /etc/nginx/.htpasswd $kibana_username $kibana_password
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE BACKUP FROM NGINX DEFAULT CONFIGURATION FILE # --------------------------------------------------------------------------------------------------- #
cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHANGE NGINX DEFAULT CONFIGURATION FILE # --------------------------------------------------------------------------------------------------------------- #
cat << EOF > /etc/nginx/sites-available/default
server {
    listen 80;

    # server_name $HOSTNAME;

    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;

    location / {
        proxy_pass http://127.0.0.1:5601;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK NGINX CONFIGURATION SYNTAX # ---------------------------------------------------------------------------------------------------------------------- #
nginx -t
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# START NGINX SERVICE # ----------------------------------------------------------------------------------------------------------------------------------- #
systemctl start nginx
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL LOGSTASH PACKAGE # ------------------------------------------------------------------------------------------------------------------------------ #
apt-get install logstash
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# STOP LOGSTASH SERVICE # --------------------------------------------------------------------------------------------------------------------------------- #
systemctl stop logstash
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ENABLE LOGSTASH SERVICE # ------------------------------------------------------------------------------------------------------------------------------- #
systemctl enable logstash
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# START LOGSTASH SERVICE # -------------------------------------------------------------------------------------------------------------------------------- #
systemctl start logstash
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# PRINT STATUS OF LOGSTASH SERVICE # ---------------------------------------------------------------------------------------------------------------------- #
systemctl status logstash
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# INSTALL FILEBEAT PACKAGE # ------------------------------------------------------------------------------------------------------------------------------ #
apt-get install filebeat
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CREATE BACKUP FROM FILEBEAT CONFIGURATION FILE # -------------------------------------------------------------------------------------------------------- #
cp /etc/filebeat/filebeat.yml /etc/filebeat/filebeat.yml.$RANDOM.backup
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHANGE FILEBEAT CONFIGURATION # ------------------------------------------------------------------------------------------------------------------------- #
sed -i 's/^output.elasticsearch/$output.elasticsearch/g' /etc/filebeat/filebeat.yml
sed -i 's/hosts: \["127.0.0.1:9200"\]/#hosts: \["127.0.0.1:9200"\]/g' /etc/filebeat/filebeat.yml
echo -e "output.logstash:" >> /etc/filebeat/filebeat.yml
echo -e "    hosts: [\"127.0.0.1:5044\"]" >> /etc/filebeat/filebeat.yml
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# ENABLE FILEBEAT MODULES IN SYSTEM # --------------------------------------------------------------------------------------------------------------------- #
filebeat modules enable system
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# SETUP AND CONNECTING FILEBEAT TO ELK # ------------------------------------------------------------------------------------------------------------------ #
filebeat setup --index-management -E output.logstash.enabled=false -E 'output.elasticsearch.hosts=["127.0.0.1:9200"]'
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# START FILEBEAT SERVICE # -------------------------------------------------------------------------------------------------------------------------------- #
systemctl start filebeat
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #

clear

# CHECK ALL INDICIES # ------------------------------------------------------------------------------------------------------------------------------------ #
curl -sXGET http://localhost:9200/_cat/indices?v
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK ELK CLUSTER HEALTH # ------------------------------------------------------------------------------------------------------------------------------ #
curl -sXGET 'http://localhost:9200/_cluster/health' | jq '.'
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# FIND SERVER IP ADDRESS # -------------------------------------------------------------------------------------------------------------------------------- #
server_ip_address=$(ifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p' | head -n 1)
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK NGINX PORT # -------------------------------------------------------------------------------------------------------------------------------------- #
netstat -ptnul | grep "\:80 " &> /dev/null
if [ "$?" = "0" ] ; then
    echo -e " [>>] ----------------------------------------------------------- [<<]"
    echo -e "\e[92m [>>] http://$server_ip_address:80 \e[0m"
    echo -e "\e[92m [>>] KIBANA USERNAME : $kibana_username \e[0m"
    echo -e "\e[92m [>>] KIBANA PASSWORD : $kibana_password \e[0m"
    echo -e " [>>] ----------------------------------------------------------- [<<]"
else
    echo -e " [>>] ----------------------------------------------------------- [<<]"
    echo -e "\e[91m [>>] SOME THINGS WRONG IN INSTALLATION \e[0m"
    echo -e " [>>] ----------------------------------------------------------- [<<]"
fi
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
